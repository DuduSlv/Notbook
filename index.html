<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestão de Notebooks — Dashboard</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: #2563eb; /* azul */
      --accent: #06b6d4;  /* teal */
      --success: #10b981;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      --radius: 12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f8fafc 0%, #eef2ff 100%);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Layout */
    .app {
      display:flex;
      min-height:100vh;
      gap:24px;
      padding:28px;
    }
    aside.sidebar {
      width:260px;
      background:linear-gradient(180deg,#1e3a8a,#3b82f6);
      color:white;
      border-radius:16px;
      padding:18px;
      box-shadow: 0 8px 30px rgba(34,50,84,0.14);
      flex-shrink:0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .brand {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:6px;
    }
    .logo {
      width:44px;height:44px;border-radius:10px;
      background:linear-gradient(135deg,#a78bfa,#60a5fa);
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 6px 18px rgba(99,102,241,0.18);
      font-weight:700;color:white;
    }
    .brand h1{font-size:16px;margin:0;font-weight:600}
    .brand p{font-size:12px;margin:0;opacity:0.95}

    nav.side-nav{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    nav.side-nav button{
      background:transparent;border:0;color:white;padding:10px 10px;border-radius:10px;text-align:left;
      display:flex;gap:12px;align-items:center;font-weight:600;cursor:pointer;
      transition:background .18s, transform .08s;
    }
    nav.side-nav button svg {opacity:0.95}
    nav.side-nav button:hover{background: rgba(255,255,255,0.06); transform:translateY(-1px)}
    nav.side-nav button.active{background: rgba(255,255,255,0.12)}

    main.content {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .topbar {
      display:flex;justify-content:space-between;align-items:center;gap:12px;
    }

    .searchbar {
      display:flex;gap:8px;align-items:center;
      background:var(--card);padding:8px 10px;border-radius:12px;box-shadow:var(--shadow);
    }
    .searchbar input{
      border:0;outline:0;font-size:14px;padding:8px;background:transparent;width:360px;
    }

    .cards {
      display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;
    }

    .card {
      background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);
    }
    .card h3{margin:0;font-size:13px;color:var(--muted);font-weight:600}
    .card p{margin:8px 0 0;font-size:22px;font-weight:700}

    .panel {
      background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow);
    }

    /* table */
    table {
      width:100%;border-collapse:collapse;font-size:14px;
    }
    thead th{
      text-align:left;padding:12px 10px;border-bottom:1px solid #eef2ff;color:var(--muted);
    }
    tbody td{
      padding:12px 10px;border-bottom:1px solid #f1f5f9;
      vertical-align:middle;
    }
    tr:hover td{background:#fbfdff}

    .badge {
      display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px;
    }
    .badge.disp{background:#eef2ff;color:#2563eb}
    .badge.uso{background:#ffede9;color:#ef4444}
    .badge.dev{background:#ecfdf5;color:#065f46}

    /* Buttons */
    .btn {
      display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;
      font-weight:600;
    }
    .btn.primary{background:var(--primary);color:white;box-shadow:0 6px 18px rgba(37,99,235,0.12)}
    .btn.ghost{background:transparent;border:1px solid #e6eefc;color:var(--primary)}
    .btn.warn{background:var(--accent);color:white}
    .btn.danger{background:var(--danger);color:white}

    .actions {display:flex;gap:8px;justify-content:flex-end}

    /* grid panels for main area */
    .grid-2 {display:grid;grid-template-columns:1fr 420px;gap:16px;align-items:start}
    .charts {display:flex;flex-direction:column;gap:12px}

    /* responsive */
    @media (max-width:1000px){ .app{padding:16px}.sidebar{display:none} .grid-2{grid-template-columns:1fr} .searchbar input{width:140px} }

    /* toast */
    #toast-container {
      position:fixed;right:20px;bottom:20px;display:flex;flex-direction:column;gap:8px;z-index:9999;
    }
    .toast {
      background:#111827;color:white;padding:10px 14px;border-radius:8px;box-shadow:0 8px 24px rgba(2,6,23,0.4);
      font-weight:600;font-size:14px;opacity:0;transform:translateY(8px);transition:opacity .18s,transform .18s;
    }
    .toast.show{opacity:1;transform:none}

    /* small helpers */
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px}
    .table-scroll{max-height:360px;overflow:auto;border-radius:8px}
    .filters{display:flex;gap:8px;align-items:center}
    .select, select, input[type="text"], input[type="date"]{padding:8px;border-radius:8px;border:1px solid #e6eefc;background:white;outline:none}
    .chip{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-weight:600}

    /* Reset button style */
    .btn-reset {
      background:transparent;color:var(--muted);border:1px solid #e6eefc;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" role="navigation">
      <div class="brand">
        <div class="logo">NB</div>
        <div>
          <h1>Gestão de Notebooks</h1>
          <p class="small">Painel administrativo</p>
        </div>
      </div>

      <nav class="side-nav" aria-label="Main">
        <button class="active" data-page="home" onclick="navTo(event,'home')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Home
        </button>

        <button data-page="notebooks" onclick="navTo(event,'notebooks')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="2" y="6" width="20" height="12" rx="2" stroke="currentColor" stroke-width="1.4"/></svg>
          Notebooks
        </button>

        <button data-page="alunos" onclick="navTo(event,'alunos')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.4"/><path d="M6 20c1.5-3 9-3 12 0" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Alunos
        </button>

        <button data-page="professores" onclick="navTo(event,'professores')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2v6" stroke="currentColor" stroke-width="1.4"/><rect x="6" y="8" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.4"/></svg>
          Professores
        </button>

        <button data-page="emprestimos" onclick="navTo(event,'emprestimos')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 7h18M7 7v10" stroke="currentColor" stroke-width="1.4"/></svg>
          Empréstimos
        </button>

        <button data-page="relatorio" onclick="navTo(event,'relatorio')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 3v18h18" stroke="currentColor" stroke-width="1.4"/></svg>
          Relatório
        </button>
      </nav>

      <div style="margin-top:auto">
        <div class="small muted">Versão</div>
        <div class="chip small" style="margin-top:8px">v1.2 — Clean UI</div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content">
      <div class="topbar">
        <div class="searchbar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#94a3b8" stroke-width="1.4" stroke-linecap="round"/></svg>
          <!-- global search input (id preserved) -->
          <input id="globalSearch" placeholder="Pesquisar (aluno, notebook, professor)..." oninput="onGlobalSearch()" />
          <div style="flex:1"></div>
          <button class="btn ghost" onclick="openBackup()">Backup</button>
          <button class="btn ghost" onclick="resetarDados()">Resetar Dados</button>
          <button class="btn primary" onclick="mostrarPagina('emprestimos')">Novo Empréstimo</button>
        </div>
      </div>

      <!-- Dashboard / container -->
      <section id="conteudo"></section>
    </main>
  </div>

  <!-- Toast container -->
  <div id="toast-container" aria-live="polite"></div>

  <script>
    // ---------- Helper UI / Toast ----------
    function showToast(msg, type = "info", ttl = 2500) {
      const c = document.getElementById('toast-container');
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      if (type === 'success') el.style.background = '#065f46';
      if (type === 'danger') el.style.background = '#991b1b';
      c.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
      setTimeout(() => {
        el.classList.remove('show');
        setTimeout(()=>el.remove(), 220);
      }, ttl);
    }

    // ---------- Navigation ----------
    function navTo(evt, page) {
      document.querySelectorAll('.side-nav button').forEach(b => b.classList.remove('active'));
      if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
      mostrarPagina(page);
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      inicializarNotebooks();
      mostrarPagina('home');
    });

    // ---------- Storage initialization ----------
    function inicializarNotebooks() {
      let notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];
      if (notebooks.length === 0) {
        const novos = [];
        for (let i = 1; i <= 20; i++) novos.push({ id: `V-${i}`, marca: "VAIO", tipo: "Notebook", status: "Disponível" });
        for (let i = 1; i <= 35; i++) novos.push({ id: `TS-${i}`, marca: "Samsung", tipo: "Tablet", status: "Disponível" });
        for (let i = 1; i <= 10; i++) novos.push({ id: `CS-${i}`, marca: "Samsung", tipo: "Chromebook", status: "Disponível" });
        for (let i = 1; i <= 20; i++) novos.push({ id: `P-${i}`, marca: "Positivo", tipo: "Notebook", status: "Disponível" });
        localStorage.setItem('notebooks', JSON.stringify(novos));
      }
      if (!localStorage.getItem('emprestimos')) localStorage.setItem('emprestimos', JSON.stringify([]));
      if (!localStorage.getItem('alunos')) localStorage.setItem('alunos', JSON.stringify([]));
      if (!localStorage.getItem('professores')) localStorage.setItem('professores', JSON.stringify([]));
    }

    // ---------- Page router ----------
    function mostrarPagina(pagina) {
      const conteudo = document.getElementById('conteudo');
      switch (pagina) {
        case 'home': renderHome(conteudo); break;
        case 'notebooks': renderNotebooks(conteudo); break;
        case 'alunos': renderAlunos(conteudo); break;
        case 'professores': renderProfessores(conteudo); break;
        case 'emprestimos': renderEmprestimos(conteudo); break;
        case 'relatorio': renderRelatorio(conteudo); break;
        default: renderHome(conteudo);
      }
    }

    // ---------- HOME (dashboard) ----------
    function renderHome(div) {
      div.innerHTML = `
        <div class="grid-2">
          <div>
            <div class="cards">
              <div class="card">
                <h3>Notebooks & Tablets</h3>
                <p id="cardNotebooks">—</p>
                <div class="muted small">Disponíveis / Em uso</div>
              </div>
              <div class="card">
                <h3>Usuários cadastrados</h3>
                <p id="cardUsuarios">—</p>
                <div class="muted small">Alunos / Professores</div>
              </div>
              <div class="card">
                <h3>Empréstimos</h3>
                <p id="cardEmprestimos">—</p>
                <div class="muted small">Ativos / Total</div>
              </div>
            </div>

            <div class="panel" style="margin-top:16px">
              <h3 style="margin:0 0 10px">Gráficos</h3>
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div style="flex:1;min-width:240px" class="panel"><canvas id="chart1" height="140"></canvas></div>
                <div style="flex:1;min-width:240px" class="panel"><canvas id="chart2" height="140"></canvas></div>
              </div>
            </div>
          </div>

          <div class="panel">
            <h3 style="margin-top:0">Últimos Empréstimos</h3>
            <div id="recentList" class="table-scroll"></div>
          </div>
        </div>
      `;
      atualizarHomeData();
    }

    function atualizarHomeData() {
      const notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];
      const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
      const professores = JSON.parse(localStorage.getItem('professores')) || [];
      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];

      const emUso = emprestimos.filter(e => e.status === 'Em uso').length;
      const disponiveis = notebooks.filter(n => n.status === 'Disponível').length;

      document.getElementById('cardNotebooks').textContent = `${disponiveis} / ${emUso}`;
      document.getElementById('cardUsuarios').textContent = `${alunos.length} / ${professores.length}`;
      document.getElementById('cardEmprestimos').textContent = `${emUso} / ${emprestimos.length}`;

      // recent list
      const recent = emprestimos.slice().reverse().slice(0,8);
      document.getElementById('recentList').innerHTML = recent.length ? `
        <table><thead><tr><th>Notebook</th><th>Aluno</th><th>Status</th></tr></thead>
        <tbody>${recent.map(r=>`<tr><td>${r.id}</td><td>${r.alunoSel}</td><td>${r.status}</td></tr>`).join('')}</tbody></table>
      ` : '<div class="muted small">Nenhum empréstimo ainda.</div>';

      // charts
      renderCharts();
    }

    function renderCharts(){
      const notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];
      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];

      const cntDisp = notebooks.filter(n => n.status === 'Disponível').length;
      const cntUso = notebooks.filter(n => n.status === 'Em uso').length;
      const ctx1 = document.getElementById('chart1').getContext('2d');
      if (window._chart1) window._chart1.destroy();
      window._chart1 = new Chart(ctx1, {
        type:'doughnut',
        data:{labels:['Disponível','Em uso'],datasets:[{data:[cntDisp,cntUso]}]},
        options:{plugins:{legend:{display:true},title:{display:true,text:'Status dos Dispositivos'}}}
      });

      const cntDev = emprestimos.filter(e=>e.status==='Devolvido').length;
      const ctx2 = document.getElementById('chart2').getContext('2d');
      if (window._chart2) window._chart2.destroy();
      window._chart2 = new Chart(ctx2, {
        type:'pie',
        data:{labels:['Em uso','Devolvidos'],datasets:[{data:[cntUso,cntDev]}]},
        options:{plugins:{legend:{display:true},title:{display:true,text:'Empréstimos'}}}
      });
    }

    // ---------- NOTEBOOKS ----------
    function renderNotebooks(div){
      const notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];
      div.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <h2 style="margin:0">Notebooks & Tablets</h2>
          <div class="filters">
            <select id="filterDevice" class="select" onchange="renderNotebooks(document.getElementById('conteudo'))">
              <option value="Todos">Todos</option>
              <option value="Notebook">Notebook</option>
              <option value="Tablet">Tablet</option>
              <option value="Chromebook">Chromebook</option>
            </select>
            <input id="searchDevice" placeholder="Buscar ID ou marca..." oninput="renderNotebooks(document.getElementById('conteudo'))" />
          </div>
        </div>

        <div class="panel table-scroll" style="margin-top:12px">
          <table>
            <thead><tr><th>ID</th><th>Marca</th><th>Tipo</th><th>Status</th></tr></thead>
            <tbody>
              ${notebooks
                .filter(n=>{
                  const f = document.getElementById('filterDevice') ? document.getElementById('filterDevice').value : 'Todos';
                  if (f!=='Todos' && n.tipo !== f) return false;
                  const q = document.getElementById('searchDevice') ? document.getElementById('searchDevice').value.toLowerCase() : '';
                  if (!q) return true;
                  return n.id.toLowerCase().includes(q) || n.marca.toLowerCase().includes(q);
                })
                .map(n=>`<tr>
                  <td>${n.id}</td>
                  <td>${n.marca}</td>
                  <td>${n.tipo}</td>
                  <td>${n.status === 'Disponível' ? '<span class="badge disp">Disponível</span>' : '<span class="badge uso">Em uso</span>'}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // ---------- ALUNOS ----------
    function renderAlunos(div){
      const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
      div.innerHTML = `
        <h2 style="margin:0 0 8px">Alunos</h2>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1" class="panel">
            <h4 style="margin:0 0 8px">Cadastrar aluno</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="nomeAluno" placeholder="Nome">
              <input id="turmaAluno" placeholder="Turma">
              <input id="numeroAluno" placeholder="Nº">
              <button class="btn primary" onclick="adicionarAluno()">Adicionar</button>
            </div>
          </div>

          <div style="flex:1" class="panel">
            <h4 style="margin:0 0 8px">Lista de alunos</h4>
            <div class="table-scroll">
              <table>
                <thead><tr><th>Nome</th><th>Turma</th><th>Nº</th></tr></thead>
                <tbody>${alunos.map(a=>`<tr><td>${a.nome}</td><td>${a.turma}</td><td>${a.numero}</td></tr>`).join('')}</tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function adicionarAluno(){
      const nome = document.getElementById('nomeAluno').value.trim();
      const turma = document.getElementById('turmaAluno').value.trim();
      const numero = document.getElementById('numeroAluno').value.trim();
      if (!nome || !turma || !numero) return showToast('Preencha todos os campos.', 'danger');

      const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
      if (alunos.some(a => a.nome === nome && a.turma === turma)) {
        showToast('Esse aluno já está cadastrado.', 'danger'); return;
      }
      alunos.push({nome, turma, numero});
      localStorage.setItem('alunos', JSON.stringify(alunos));
      showToast('Aluno adicionado.', 'success');
      renderAlunos(document.getElementById('conteudo'));
    }

    // ---------- PROFESSORES ----------
    function renderProfessores(div){
      const professores = JSON.parse(localStorage.getItem('professores')) || [];
      div.innerHTML = `
        <h2 style="margin:0 0 8px">Professores</h2>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1" class="panel">
            <h4 style="margin:0 0 8px">Cadastrar professor</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="nomeProf" placeholder="Nome">
              <input id="materiaProf" placeholder="Matéria">
              <input id="turmaProf" placeholder="Turma">
              <button class="btn primary" onclick="adicionarProfessor()">Adicionar</button>
            </div>
          </div>

          <div style="flex:1" class="panel">
            <h4 style="margin:0 0 8px">Lista de professores</h4>
            <div class="table-scroll">
              <table>
                <thead><tr><th>Nome</th><th>Matéria</th><th>Turma</th></tr></thead>
                <tbody>${professores.map(p=>`<tr><td>${p.nome}</td><td>${p.materia}</td><td>${p.turma}</td></tr>`).join('')}</tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function adicionarProfessor(){
      const nome = document.getElementById('nomeProf').value.trim();
      const materia = document.getElementById('materiaProf').value.trim();
      const turma = document.getElementById('turmaProf').value.trim();
      if (!nome || !materia || !turma) return showToast('Preencha todos os campos.', 'danger');

      const professores = JSON.parse(localStorage.getItem('professores')) || [];
      if (professores.some(p => p.nome === nome && p.materia === materia)) {
        showToast('Esse professor já está cadastrado.', 'danger'); return;
      }
      professores.push({nome, materia, turma});
      localStorage.setItem('professores', JSON.stringify(professores));
      showToast('Professor adicionado.', 'success');
      renderProfessores(document.getElementById('conteudo'));
    }

    // ---------- EMPRÉSTIMOS ----------
    let selecionados = []; // ids dos notebooks selecionados

    function renderEmprestimos(div){
      const alunos = JSON.parse(localStorage.getItem('alunos')) || [];
      const professores = JSON.parse(localStorage.getItem('professores')) || [];
      const notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];
      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];

      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Empréstimos</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="filtroStatusEmp" class="select" onchange="renderEmprestimos(document.getElementById('conteudo'))">
              <option value="Todos">Todos</option>
              <option value="Em uso">Em uso</option>
              <option value="Devolvido">Devolvido</option>
            </select>
            <input id="searchEmp" placeholder="Pesquisar..." oninput="renderEmprestimos(document.getElementById('conteudo'))" />
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:320px" class="panel">
            <h4 style="margin:0 0 8px">Novo Empréstimo</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <select id="alunoSel">
                <option value="">Selecione o aluno</option>
                ${alunos.map(a=>`<option value="${a.nome}">${a.nome} — ${a.turma}</option>`).join('')}
              </select>
              <select id="profSel">
                <option value="">Selecione o professor</option>
                ${professores.map(p=>`<option value="${p.nome}">${p.nome} — ${p.materia}</option>`).join('')}
              </select>
              <button class="btn primary" onclick="iniciarEmprestimo()">Iniciar</button>
            </div>

            <h5 style="margin:12px 0 8px">Selecionar dispositivos</h5>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">
              ${notebooks.map(n=>`
                <button class="btn" id="nb-${n.id}" style="justify-content:flex-start;border:1px solid #eef2ff;border-radius:10px; ${n.status==='Em uso' ? 'opacity:0.6;cursor:not-allowed' : ''}" onclick="toggleNotebook('${n.id}', this)">
                  <div style="min-width:36px;min-height:36px;border-radius:8px;background:#f8fafc;display:flex;align-items:center;justify-content:center;font-weight:700">${n.marca[0]||'?'}</div>
                  <div style="text-align:left">
                    <div style="font-weight:700">${n.id}</div>
                    <div class="small muted">${n.marca} • ${n.tipo}</div>
                  </div>
                </button>
              `).join('')}
            </div>
          </div>

          <div style="flex:1;min-width:420px" class="panel">
            <h4 style="margin:0 0 8px">Lista de Empréstimos</h4>
            <div class="table-scroll">
              <table>
                <thead><tr><th>ID</th><th>Aluno</th><th>Professor</th><th>Status</th><th>Data</th><th style="text-align:right">Ações</th></tr></thead>
                <tbody>
                  ${emprestimos
                    .filter(e=>{
                      const filtro = document.getElementById('filtroStatusEmp') ? document.getElementById('filtroStatusEmp').value : 'Todos';
                      if (filtro !== 'Todos' && e.status !== filtro) return false;
                      const q = document.getElementById('searchEmp') ? document.getElementById('searchEmp').value.toLowerCase() : '';
                      if (!q) return true;
                      return (e.id + ' ' + e.alunoSel + ' ' + e.profSel).toLowerCase().includes(q);
                    })
                    .map((e,i)=>`<tr>
                      <td>${e.id}</td>
                      <td>${e.alunoSel}</td>
                      <td>${e.profSel}</td>
                      <td>${e.status === 'Em uso' ? '<span class="badge uso">Em uso</span>' : '<span class="badge dev">Devolvido</span>'}</td>
                      <td>${e.dataDevolucao || e.data || '-'}</td>
                      <td style="text-align:right">
                        ${e.status === 'Em uso'
                          ? `<button class="btn primary" onclick="devolverEmprestimo(${i})">Devolver</button>`
                          : `<button class="btn danger" onclick="excluirEmprestimo(${i})">Excluir</button>`}
                      </td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function toggleNotebook(id, btn){
      const notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];
      const found = notebooks.find(n=>n.id===id);
      if (!found || found.status === 'Em uso') return; // cannot select in-use
      if (selecionados.includes(id)){
        selecionados = selecionados.filter(x=>x!==id);
        btn.style.boxShadow = 'none';
        btn.style.borderColor = '#eef2ff';
      } else {
        selecionados.push(id);
        btn.style.boxShadow = '0 8px 20px rgba(37,99,235,0.12)';
        btn.style.borderColor = '#c7ddff';
      }
    }

    function iniciarEmprestimo(){
      const alunoSel = document.getElementById('alunoSel').value;
      const profSel = document.getElementById('profSel').value;
      if (!alunoSel || !profSel || selecionados.length === 0) return showToast('Selecione aluno, professor e pelo menos um dispositivo.', 'danger');

      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];
      const notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];

      const novos = selecionados.map(id => {
        const nb = notebooks.find(n=>n.id===id);
        if (nb) nb.status = 'Em uso';
        return { id, alunoSel, profSel, status: 'Em uso', data: new Date().toLocaleString('pt-BR') };
      });

      emprestimos.push(...novos);
      localStorage.setItem('emprestimos', JSON.stringify(emprestimos));
      localStorage.setItem('notebooks', JSON.stringify(notebooks));
      selecionados = [];
      showToast('Empréstimo iniciado.', 'success');
      renderEmprestimos(document.getElementById('conteudo'));
      atualizarHomeData();
    }

    function devolverEmprestimo(index){
      let emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];
      if (!emprestimos[index]) return showToast('Empréstimo não encontrado.', 'danger');
      if (emprestimos[index].status === 'Devolvido') return showToast('Já foi devolvido.', 'danger');

      emprestimos[index].status = 'Devolvido';
      emprestimos[index].dataDevolucao = new Date().toLocaleString('pt-BR');

      const notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];
      const nb = notebooks.find(n=>n.id === emprestimos[index].id);
      if (nb) nb.status = 'Disponível';

      localStorage.setItem('emprestimos', JSON.stringify(emprestimos));
      localStorage.setItem('notebooks', JSON.stringify(notebooks));

      showToast('Empréstimo devolvido.', 'success');
      renderEmprestimos(document.getElementById('conteudo'));
      atualizarHomeData();
    }

    function excluirEmprestimo(index){
      if (!confirm('Excluir este empréstimo permanentemente?')) return;
      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];
      emprestimos.splice(index,1);
      localStorage.setItem('emprestimos', JSON.stringify(emprestimos));
      showToast('Empréstimo excluído.', 'success');
      renderEmprestimos(document.getElementById('conteudo'));
      atualizarHomeData();
    }

    // ---------- RELATÓRIO ----------
    function renderRelatorio(div){
      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Relatório</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="filtroRel" class="select" onchange="filtrarRelatorio()">
              <option value="Todos">Todos</option>
              <option value="Em uso">Em uso</option>
              <option value="Devolvido">Devolvido</option>
            </select>
            <button class="btn ghost" onclick="exportCSV()">Exportar CSV</button>
          </div>
        </div>

        <div class="panel table-scroll" style="margin-top:12px">
          <table id="tableRel">
            <thead><tr><th>Notebook</th><th>Aluno</th><th>Professor</th><th>Status</th><th>Data</th></tr></thead>
            <tbody>
              ${emprestimos.map(e=>`<tr>
                <td>${e.id}</td>
                <td>${e.alunoSel}</td>
                <td>${e.profSel}</td>
                <td>${e.status}</td>
                <td>${e.dataDevolucao || e.data || '-'}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function filtrarRelatorio(){
      const filtro = document.getElementById('filtroRel').value;
      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];
      const corpo = document.querySelector('#tableRel tbody');
      corpo.innerHTML = emprestimos
        .filter(e => filtro === 'Todos' || e.status === filtro)
        .map(e => `<tr>
          <td>${e.id}</td><td>${e.alunoSel}</td><td>${e.profSel}</td><td>${e.status}</td><td>${e.dataDevolucao || e.data || '-'}</td>
        </tr>`).join('');
    }

    // ---------- Search global (top) ----------
    function onGlobalSearch(){
      const q = document.getElementById('globalSearch').value.trim().toLowerCase();
      if (!q) {
        // if empty, go back to home
        mostrarPagina('home');
        return;
      }

      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];
      const notebooks = JSON.parse(localStorage.getItem('notebooks')) || [];
      const alunos = JSON.parse(localStorage.getItem('alunos')) || [];

      // If query matches notebook id or brand -> go to notebooks and set local search
      if (notebooks.some(n => n.id.toLowerCase().includes(q) || n.marca.toLowerCase().includes(q))) {
        mostrarPagina('notebooks');
        // set searchDevice after render
        setTimeout(()=> {
          const el = document.getElementById('searchDevice');
          if (el) { el.value = q; renderNotebooks(document.getElementById('conteudo')); }
        }, 80);
        return;
      }

      // If matches aluno name -> go to alunos
      if (alunos.some(a => a.nome.toLowerCase().includes(q))) {
        mostrarPagina('alunos');
        // no specific search input on Alunos page; show toast to guide user
        showToast('Navegue na lista de alunos; termo: "'+q+'".', 'info', 1800);
        return;
      }

      // If matches emprestimos (by aluno, id or professor) -> go to emprestimos and set search
      if (emprestimos.some(e => (e.alunoSel + ' ' + e.id + ' ' + e.profSel).toLowerCase().includes(q))) {
        mostrarPagina('emprestimos');
        setTimeout(()=> {
          const se = document.getElementById('searchEmp');
          if (se) { se.value = q; renderEmprestimos(document.getElementById('conteudo')); }
        }, 80);
        return;
      }

      showToast('Nenhum resultado rápido. Tente navegar nas páginas.', 'info', 1600);
    }

    // ---------- Reset data ----------
    function resetarDados(){
      if (!confirm('Tem certeza que deseja apagar todos os dados do sistema?')) return;
      localStorage.clear();
      showToast('Dados apagados — recarregando...', 'success', 1200);
      setTimeout(()=> location.reload(), 900);
    }

    // ---------- Backup / Export ----------
    function openBackup(){
      const data = {
        notebooks: JSON.parse(localStorage.getItem('notebooks')||'[]'),
        alunos: JSON.parse(localStorage.getItem('alunos')||'[]'),
        professores: JSON.parse(localStorage.getItem('professores')||'[]'),
        emprestimos: JSON.parse(localStorage.getItem('emprestimos')||'[]')
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_gestao_notebooks_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Backup gerado.', 'success');
    }

    function exportCSV(){
      const emprestimos = JSON.parse(localStorage.getItem('emprestimos')||'[]');
      if (!emprestimos.length) return showToast('Sem dados para exportar.', 'danger');
      const headers = ['Notebook','Aluno','Professor','Status','Data'];
      const rows = emprestimos.map(e => [e.id, e.alunoSel, e.profSel, e.status, e.dataDevolucao || e.data || '']);
      const csv = [headers, ...rows].map(r => r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `relatorio_emprestimos_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
      showToast('CSV exportado.', 'success');
    }
  </script>
</body>
</html>
